<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BESI Remote Monitoring</title>
</head>
<body>
    <h1>BESI Remote Monitoring</h1>
    <div id="root"></div>
</body>

<script>
    const durations = [
        [1000,60,"seconds",],
        [60*1000,60,"minutes"],
        [60*60*1000,24,"hours"],
        [24*60*60*1000,7,"days"],
        [7*24*60*60*1000,4,"weeks"],
        [4*7*24*60*60*1000,12,"months"],
        [12*4*7*24*60*60*1000,1000,"years"]
    ]

    function getAgoString(v){
        v = Date.now() - v
        str = ''
        for(i=0; i<7; i++){
            let val = durations[i]
            if(Math.ceil(v/val[0])<val[1]){
                str = `${Math.ceil(v/val[0])} ${val[2]} ago`
                break
            }
        }

        return str
    }

    function stringify(deployments){
        let body = ''
        Object.keys(deployments).forEach((i)=>{
            let dep = deployments[i]
            let depbody = `<h2>${dep.DeploymentID}</h2>\n`
            depbody += `<span><b>BaseStation ID:</b> ${dep.DeviceID} | Last reported online: ${(dep.lastupdated ? getAgoString(dep.lastupdated) : 'Not reported')}</span>\n<br>\n`
            let relays = "<h3>Relays:</h3>\n<ul>\n"
                try{
                    Object.keys(dep.relays).forEach((j)=>{
                    let r = dep.relays[j]
                    let relay = `<li><b>${r.DeviceID}:</b> | Lux: ${r.LUX} | Humidity: ${r.HUM}% | Temperature: ${r.TMP}&#8451 | Pressure: ${r.PRS}kPa | Last Updated: ${getAgoString(r.lastupdated)}</li>\n<br>\n`
                    relays += relay
                    })
                } catch (e) {
                    console.log(e)
                }
                
            relays += "</ul>\n<hr>"
            depbody += relays
            body += depbody
        })

        return body
    }

    function update(){
        let root = document.getElementById('root')
        fetch("http://remote.besic.org/status").then((res)=>{
            console.log(res)
            res.json().then((r)=>{
                console.log(r)
                let stuff = stringify(r.deployments)

                console.log(stuff)
                // Put the thing in the DOM
                root.innerHTML = stuff

                console.log("Set HTML")
                // Call itself on timeout
                setTimeout(update, 1000);

            }).catch((e)=>{
                console.log("Error:",e)
            })
        }).catch((e)=>{
            console.log("Error:",e)
        })
    }

    update()
</script>
</html>